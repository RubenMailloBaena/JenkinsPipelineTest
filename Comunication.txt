pipeline {
    agent any
    
    parameters {
        string(
            name: 'NEW_VERSION',
            defaultValue: '1.0.1',
            description: 'Nueva versi√≥n del microservicio'
        )
    }


    environment {
        APP_NAME     = "upgrade_version_micro_example"
        MICRO_PATH   = "Jenkins_VM_UpgradeMicroVersion/upgrade_version_micro_example"
        WILDFLY_HOME = "/opt/wildfly"
        WILDFLY_USER = "*****"
        WILDFLY_PASS = "*****"
        NGINX_CONF   = "/etc/nginx/conf.d/test.conf"
    }

    stages {

        //Clonamos el repositorio de git donde se encuentra el micro
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/RubenMailloBaena/JenkinsPipelineTest.git'
            }
        }

        //Nos movemos dentrod del micro para generar un .war con la nueva version
        stage('Build WAR') {
            steps {
                dir("${MICRO_PATH}") {
                    sh """
                        mvn versions:set \
                        -DnewVersion=${params.NEW_VERSION} \
                        -DgenerateBackupPoms=false
                        mvn clean package
                    """
                }
            }
        }

        //Buscamos en la configuracion de NGINX a que micro estamos apuntando desde el proxy.
        //Si apuntamos a blue, ese sera el que esta activo en JBOSS, por lo que tendremos que 
        //subir el green. Y lo mismo al contrario.
        stage('Detect Active Color') {
            steps {
                script {
                    //Obtenemos el que esta apuntando el proxy
                    def active = sh(
                        script: "grep proxy_pass ${NGINX_CONF} | grep -oE '(blue|green)'",
                        returnStdout: true
                    ).trim()

                    //Si no lo encontramos, damos por hecho que es el azul.
                    if (!active) {
                        active = "blue"
                    }

                    env.ACTIVE = active
                    env.NEW = (active == "blue") ? "green" : "blue"

                    echo "Active: ${env.ACTIVE}"
                    echo "New: ${env.NEW}"
                }
            }
        }

        //Desplegamos el micro con la nueva version a JBOSS.
        stage('Deploy new micro to JBOSS') {
            steps {
                dir("${MICRO_PATH}") {
                    sh """
                        ${WILDFLY_HOME}/bin/jboss-cli.sh --connect \
                        --user=${WILDFLY_USER} \
                        --password=${WILDFLY_PASS} \
                        --command="deploy target/${APP_NAME}.war --name=${NEW}.war --force"
                    """
                }
            }
        }

        //Una vez desplegado, hacemos unos cuantos curls al endpoint del nuevo micro.
        //Para comprobar que esta activo y funciona.
        stage('Health Check new micro') {
            steps {
                sh """
                    for i in {1..10}; do
                        if curl -f http://127.0.0.1:8080/${NEW}/version; then
                            exit 0
                        fi
                        sleep 2
                    done
                    exit 1
                """
            }
        }

        //En caso de llegar a este stage, significa que el nuevo micro esta activo y funciona.
        //Por lo tanto, accedemos a la configuracion del proxy y la cambiamos para que apunte 
        //al nuevo micro y le hacemos un reload. Cambiando practicamente al instante, sin caida de servicio.
        stage('Switch Nginx') {
            steps {
                sh """
                    sudo sed -i 's|proxy_pass .*|proxy_pass http://127.0.0.1:8080/${NEW}/version;|' ${NGINX_CONF}
                    sudo nginx -s reload
                """
            }
        }
        
        //Por ultimo, una vez que que ya esta activo el nuevo micro, hacemos un undeploy del micro antiguo.
        stage('Undeploy previous version') {
            steps {
                sh '''
                    DEPLOY_EXISTS=$(/opt/wildfly/bin/jboss-cli.sh --connect \
                      --user="$WILDFLY_USER" --password="$WILDFLY_PASS" \
                      --command="deployment-info" | grep -w "${ACTIVE}.war" || true)
                
                    if [ -n "$DEPLOY_EXISTS" ]; then
                      echo "Undeploying ${ACTIVE}.war"
                      /opt/wildfly/bin/jboss-cli.sh --connect \
                        --user="$WILDFLY_USER" --password="$WILDFLY_PASS" \
                        --command="undeploy ${ACTIVE}.war"
                      echo "${ACTIVE}.war undeployed successfully"
                    else
                      echo "${ACTIVE}.war not found"
                    fi
                '''
            }
        }
    }
}
