pipeline {
    agent any
    
    parameters{
       base64File 'inputFile'
    }

    environment {
        REPO_URL = 'https://github.com/RubenMailloBaena/JenkinsPipelineTest.git'
        BRANCH = 'main'
        ANT_DIR = 'repo-temp/ant_files'
        VALID_FORMATS = '.txt,.xml'
    }

    stages {
        stage('Validating Input File'){
            steps{
                withFileParameter('inputFile'){
                    powershell '''
                        $input = "$env:inputFile"
                        $length = (Get-Item $input).Length
                        $filename = "$env:inputFile_FILENAME"
                        $ext = [System.IO.Path]::GetExtension($filename).ToLower()
                        
                        if($length -eq 0){
                            Write-Host "[ERROR]: The file content can't be empty: $input"
                            exit 1
                        }
                        
                        $validExts = "$env:VALID_FORMATS".Split(',')
                        if(-not $validExts.Contains($ext)){
                            Write-Host "[ERROR]: Invalid file format: $ext --> allowed formats: $validExts"
                            exit 1
                        }
                        
                        Write-Host "Input File Validated!"
                    '''
                }
            }
        }
        
        stage('Prepare Workspace') {
            steps {
                script {
                    powershell '''
                        if (Test-Path -Path repo-temp) {
                            Remove-Item -Path repo-temp -Recurse -Force
                        }
                        mkdir repo-temp
                    '''
                }
            }
        }

        stage('CLonar Repositorio') { 
            steps {
                dir('repo-temp'){
                    git branch: "${env.BRANCH}", url: "${env.REPO_URL}"
                }
            }
        }
        
        stage('Compilar con Ant task'){
            steps{
                withFileParameter('inputFile'){
                    dir(env.ANT_DIR){
                        script{
                            def antHome = tool name: 'Ant Installation', type: 'hudson.tasks.Ant$AntInstallation'
                            def mavenHome = tool name: 'Maven Installation', type: 'hudson.tasks.Maven$MavenInstallation'
                            def mvnCmd = "${mavenHome}\\bin\\mvn.cmd"
                            
                            bat """
                                set INPUT_FILE=${inputFile}
                                set MVN_CMD=${mvnCmd}
                                "${antHome}\\bin\\ant.bat" -Dinput.file=%INPUT_FILE% -Dmvn.cmd=%MVN_CMD%
                            """
                        }
                    }
                }
            }
        }
    }
}


-----------------------------------
pipeline {
    agent any
    
    parameters{
       base64File 'inputFile'
    }

    environment {
        REPO_URL = 'https://github.com/RubenMailloBaena/JenkinsPipelineTest.git'
        BRANCH = 'main'
        ANT_DIR = 'repo-temp/tools'
        XML_DIR = 'repo-temp/resources/XML'
        JAVA_DIR = 'repo-temp/resources/Java'
        VALID_FORMATS = '.txt,.xml'
    }

    stages {
        stage('Validating Input File'){
            steps{
                withFileParameter('inputFile'){
                    powershell '''
                        $input = "$env:inputFile"
                        $length = (Get-Item $input).Length
                        $filename = "$env:inputFile_FILENAME"
                        $ext = [System.IO.Path]::GetExtension($filename).ToLower()
                        
                        if($length -eq 0){
                            Write-Host "[ERROR]: The file content can't be empty: $input"
                            exit 1
                        }
                        
                        $validExts = "$env:VALID_FORMATS".Split(',')
                        if(-not $validExts.Contains($ext)){
                            Write-Host "[ERROR]: Invalid file format: $ext --> allowed formats: $validExts"
                            exit 1
                        }
                        
                        Write-Host "Input File Validated!"
                    '''
                }
            }
        }
        
        stage('Prepare Workspace') {
            steps {
                script {
                    powershell '''
                        if (Test-Path -Path repo-temp) {
                            Remove-Item -Path repo-temp -Recurse -Force
                        }
                        mkdir repo-temp
                    '''
                }
            }
        }

        stage('CLonar Repositorio') { 
            steps {
                dir('repo-temp'){
                    git branch: "${env.BRANCH}", url: "${env.REPO_URL}"
                }
            }
        }
        
        stage('Convert XML to Java'){
            steps{
                withFileParameter('inputFile'){
                    dir ('repo-temp/tools'){
                       script{
                            def filename = "${env.inputFile_FILENAME}"
                            echo filename
                            def inputFile = "$env:inputFile"
                            def outputJavaFile = "${env.JAVA_DIR}/${filename}.java"
                            
                            bat """
                                java XMLToJavaConverter ${inputFile} ${outputJavaFile}
                            """
                            echo "Java class generated: ${outputJavaFile}"
                        } 
                    }
                }
            }
        }
        
        stage('Compilar con Ant task'){
            steps{
                withFileParameter('inputFile'){
                    dir(env.ANT_DIR){
                        script{
                            def antHome = tool name: 'Ant Installation', type: 'hudson.tasks.Ant$AntInstallation'
                            def mavenHome = tool name: 'Maven Installation', type: 'hudson.tasks.Maven$MavenInstallation'
                            def mvnCmd = "${mavenHome}\\bin\\mvn.cmd"
                            
                            bat """
                                set INPUT_FILE=${inputFile}
                                set MVN_CMD=${mvnCmd}
                                "${antHome}\\bin\\ant.bat" -Dinput.file=%INPUT_FILE% -Dmvn.cmd=%MVN_CMD%
                            """
                        }
                    }
                }
            }
        }
    }
}



